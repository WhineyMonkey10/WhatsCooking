<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>What's Cooking? - Appwrite Commit Analysis</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/appwrite@16.0.2/dist/iife/sdk.js"></script>
    <style>
        :root {
            /* Enhanced Color Palette */
            --primary-color: #7c3aed;
            --primary-light: #8b5cf6;
            --primary-dark: #6d28d9;
            --primary-50: #f5f3ff;
            --primary-100: #ede9fe;
            --primary-500: #7c3aed;
            --primary-600: #6d28d9;
            --primary-700: #5b21b6;
            
            --accent-color: #f59e0b;
            --accent-light: #fbbf24;
            --accent-dark: #d97706;
            
            --success-color: #10b981;
            --success-light: #34d399;
            --error-color: #ef4444;
            --error-light: #f87171;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            
            /* Typography Scale */
            --text-dark: #111827;
            --text-medium: #374151;
            --text-light: #6b7280;
            --text-muted: #9ca3af;
            
            /* Background Colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --bg-overlay: rgba(17, 24, 39, 0.8);
            
            /* Border Colors */
            --border-light: #f3f4f6;
            --border-color: #e5e7eb;
            --border-dark: #d1d5db;
            
            /* Enhanced Shadows */
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            
            /* Enhanced Border Radius */
            --radius-xs: 0.25rem;
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-3xl: 2rem;
            --radius-full: 9999px;
            
            /* Enhanced Transitions */
            --transition-fast: all 0.15s ease;
            --transition-base: all 0.2s ease;
            --transition-slow: all 0.3s ease;
            --transition-bounce: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            
            /* Spacing Scale */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            --space-16: 4rem;
            --space-20: 5rem;
            
            /* Typography Weights */
            --font-light: 300;
            --font-normal: 400;
            --font-medium: 500;
            --font-semibold: 600;
            --font-bold: 700;
            --font-extrabold: 800;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-weight: var(--font-normal);
            line-height: 1.65;
            color: var(--text-dark);
            background-color: var(--bg-secondary);
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            width: 100%;
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 var(--space-6);
        }

        /* Layout */
        .page-wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 20%);
        }

        main {
            flex: 1;
            padding: var(--space-8) 0;
        }

        /* Enhanced Typography */
        h1, h2, h3, h4, h5, h6 {
            font-weight: var(--font-bold);
            line-height: 1.2;
            letter-spacing: -0.025em;
            color: var(--text-dark);
        }

        h1 {
            font-size: clamp(2.25rem, 4vw, 3.5rem);
            font-weight: var(--font-extrabold);
            line-height: 1.1;
        }

        h2 {
            font-size: clamp(1.875rem, 3vw, 2.25rem);
            font-weight: var(--font-bold);
        }

        h3 {
            font-size: clamp(1.5rem, 2.5vw, 1.875rem);
            font-weight: var(--font-semibold);
        }

        h4 {
            font-size: 1.25rem;
            font-weight: var(--font-semibold);
        }

        p {
            margin-bottom: var(--space-4);
            font-size: 1rem;
            line-height: 1.7;
            color: var(--text-medium);
        }

        .lead {
            font-size: 1.25rem;
            font-weight: var(--font-medium);
            color: var(--text-medium);
            line-height: 1.6;
        }

        /* Header/Hero Section */
        .hero {
            background: linear-gradient(135deg, 
                var(--primary-700) 0%, 
                var(--primary-600) 25%, 
                var(--primary-500) 50%, 
                var(--accent-color) 100%);
            color: white;
            padding: var(--space-16) 0 var(--space-20);
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.08;
        }

        .hero::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 30% 40%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
        }

        .hero-content {
            max-width: 900px;
            margin: 0 auto;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .hero-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-4);
            margin-bottom: var(--space-6);
            flex-wrap: wrap;
        }

        .hero-emoji {
            font-size: clamp(2.5rem, 5vw, 4rem);
            display: inline-block;
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.2));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .hero-description {
            font-size: clamp(1.125rem, 2vw, 1.375rem);
            opacity: 0.95;
            margin-bottom: var(--space-10);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            font-weight: var(--font-medium);
            line-height: 1.6;
        }

        .hero-buttons {
            display: flex;
            gap: var(--space-4);
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: var(--space-8);
        }

        .tag-container {
            display: flex;
            gap: var(--space-3);
            justify-content: center;
            margin-bottom: var(--space-10);
            flex-wrap: wrap;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            background: rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            font-weight: var(--font-medium);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            transition: var(--transition-base);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .tag:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        /* Enhanced Cards */
        .card {
            background: var(--bg-primary);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-lg);
            margin-bottom: var(--space-6);
            overflow: hidden;
            border: 1px solid var(--border-light);
            transition: var(--transition-base);
            position: relative;
        }

        .card:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-4px);
            border-color: var(--border-color);
        }

        .card-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--primary-50) 100%);
        }

        .card-body {
            padding: var(--space-6);
        }

        .card-title-group {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .card-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .card-icon::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
            z-index: 1;
        }

        .card-icon.primary {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.3);
        }

        .card-icon.info {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .card-icon.warning {
            background: linear-gradient(135deg, var(--warning-color), #fbbf24);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }

        .card-title {
            font-size: 1.375rem;
            margin: 0;
            font-weight: var(--font-bold);
            color: var(--text-dark);
        }

        .card-body {
            padding: var(--space-6);
        }

        /* Enhanced Badge System */
        .badge-group {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: var(--font-semibold);
            text-transform: uppercase;
            letter-spacing: 0.025em;
            transition: var(--transition-base);
            box-shadow: var(--shadow-sm);
        }

        .badge.primary {
            background: linear-gradient(135deg, var(--primary-100), var(--primary-50));
            color: var(--primary-700);
            border: 1px solid var(--primary-200);
        }

        .badge.success {
            background: linear-gradient(135deg, #dcfce7, #f0fdf4);
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .badge.neutral {
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            color: var(--text-medium);
            border: 1px solid var(--border-color);
        }

        .badge.error {
            background: linear-gradient(135deg, #fee2e2, #fef2f2);
            color: #b91c1c;
            border: 1px solid #fecaca;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: var(--space-6);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-2);
            font-weight: var(--font-semibold);
            color: var(--text-dark);
            font-size: 0.875rem;
        }

        .form-control {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            font-size: 1rem;
            line-height: 1.5;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-xl);
            transition: var(--transition-base);
            background: var(--bg-primary);
            font-weight: var(--font-medium);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
            background: var(--bg-primary);
        }

        .form-control::placeholder {
            color: var(--text-muted);
            font-weight: var(--font-normal);
        }

        .select-wrapper {
            position: relative;
            display: inline-block;
        }

        .select-wrapper::after {
            content: '‚ñº';
            position: absolute;
            right: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            font-size: 0.75rem;
            color: var(--text-medium);
            transition: var(--transition-base);
        }

        .select {
            appearance: none;
            padding-right: 2.5rem;
            background-color: var(--bg-primary);
            cursor: pointer;
            transition: var(--transition-base);
        }

        .select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        /* Enhanced Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-6);
            font-size: 0.875rem;
            font-weight: var(--font-semibold);
            text-align: center;
            border: none;
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: var(--transition-bounce);
            line-height: 1.5;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            min-height: 48px;
        }

        .btn::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            transition: var(--transition-base);
            z-index: -1;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-600), var(--primary-500));
            color: white;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-primary::before {
            background: linear-gradient(135deg, var(--primary-700), var(--primary-600));
            opacity: 0;
        }

        .btn-primary:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px) scale(1.02);
        }

        .btn-primary:hover::before {
            opacity: 1;
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: var(--text-dark);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(12px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary::before {
            background: rgba(255, 255, 255, 1);
            opacity: 0;
        }

        .btn-secondary:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary:hover::before {
            opacity: 1;
        }

        .btn-secondary:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-icon {
            width: 48px;
            height: 48px;
            padding: 0;
            border-radius: var(--radius-full);
            font-size: 1.25rem;
        }

        /* Loading States */
        .loading-container {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(124, 58, 237, 0.1);
            border-top-color: var(--primary-500);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.3);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .skeleton {
            background: linear-gradient(110deg, 
                var(--bg-tertiary) 8%, 
                var(--border-light) 18%, 
                var(--bg-tertiary) 33%);
            background-size: 200% 100%;
            animation: loading 1.8s infinite ease-in-out;
            border-radius: var(--radius-xl);
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-line {
            height: 1.25rem;
            margin-bottom: 0.75rem;
        }

        .skeleton-block {
            height: 8rem;
            margin: 1rem 0;
        }

        /* Enhanced Analysis Results */
        .version-selector {
            margin-bottom: var(--space-8);
            background: var(--bg-primary);
            border-radius: var(--radius-2xl);
            padding: var(--space-5);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-4);
            border: 2px solid var(--border-light);
            backdrop-filter: blur(12px);
            transition: var(--transition-base);
        }

        .version-selector:hover {
            box-shadow: var(--shadow-xl);
            border-color: var(--border-color);
        }

        .version-label {
            font-weight: var(--font-semibold);
            color: var(--text-dark);
            font-size: 1rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-6);
        }

        @media (min-width: 992px) {
            .results-grid {
                grid-template-columns: 2fr 1fr;
            }
        }

        .timeline-item {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-bottom: 1rem;
            background-color: white;
            transition: var(--transition);
        }

        .timeline-item:hover {
            box-shadow: var(--shadow-md);
        }

        .timeline-item.feature {
            border-left: 4px solid #10b981;
        }

        .timeline-item.no-feature {
            border-left: 4px solid var(--text-light);
        }

        .timeline-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .timeline-date {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .timeline-content {
            display: none;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .timeline-content.expanded {
            display: block;
        }

        .last-updated {
            text-align: center;
            margin-top: 2rem;
            color: var(--text-medium);
            font-size: 0.875rem;
        }

        /* Enhanced Alert */
        .alert {
            display: flex;
            align-items: flex-start;
            gap: var(--space-4);
            padding: var(--space-5);
            border-radius: var(--radius-2xl);
            margin-bottom: var(--space-6);
            box-shadow: var(--shadow-md);
            border: 2px solid transparent;
            backdrop-filter: blur(12px);
            transition: var(--transition-base);
        }

        .alert.error {
            background: linear-gradient(135deg, #fee2e2, #fef2f2);
            border-color: #fecaca;
            color: #b91c1c;
        }

        .alert:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        /* Enhanced Footer */
        .footer {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--primary-50) 100%);
            border-top: 2px solid var(--border-light);
            padding: var(--space-12) 0;
            margin-top: var(--space-16);
        }

        .footer-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .footer-text {
            color: var(--text-medium);
            font-size: 0.875rem;
        }

        .footer-links {
            display: flex;
            gap: 1.5rem;
        }

        .footer-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .footer-link:hover {
            color: var(--primary-dark);
        }

        /* Enhanced Prose/Content Styles */
        .prose {
            font-size: 1rem;
            line-height: 1.7;
            color: var(--text-medium);
        }

        .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
            font-weight: var(--font-bold);
            color: var(--text-dark);
            margin-top: var(--space-6);
            margin-bottom: var(--space-4);
            line-height: 1.3;
        }

        .prose h1 { font-size: 2rem; }
        .prose h2 { font-size: 1.75rem; }
        .prose h3 { font-size: 1.5rem; }
        .prose h4 { font-size: 1.25rem; }

        .prose p {
            margin-bottom: var(--space-4);
        }

        .prose ul, .prose ol {
            margin-bottom: var(--space-4);
            padding-left: var(--space-6);
        }

        .prose li {
            margin-bottom: var(--space-2);
        }

        .prose strong {
            font-weight: var(--font-bold);
            color: var(--text-dark);
        }

        .prose code {
            background: var(--bg-tertiary);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: 0.875em;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .prose blockquote {
            border-left: 4px solid var(--primary-color);
            padding-left: var(--space-4);
            margin: var(--space-6) 0;
            font-style: italic;
            color: var(--text-medium);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            padding: 1rem;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-container {
            background-color: white;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-container {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            transition: var(--transition);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* How it works */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .feature-card {
            text-align: center;
            padding: 1.5rem;
            border-radius: var(--radius-md);
            background-color: var(--bg-light);
            transition: var(--transition);
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .feature-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: white;
            font-size: 1.5rem;
        }

        .feature-icon.blue { background: linear-gradient(135deg, #3b82f6, #60a5fa); }
        .feature-icon.green { background: linear-gradient(135deg, #10b981, #34d399); }
        .feature-icon.purple { background: linear-gradient(135deg, #8b5cf6, #a78bfa); }
        .feature-icon.orange { background: linear-gradient(135deg, #f59e0b, #fbbf24); }

        .feature-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .feature-desc {
            font-size: 0.875rem;
            color: var(--text-medium);
        }

        /* Subscription Form */
        .subscription-form {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .subscription-message {
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-top: 1.25rem;
            display: none;
        }

        .subscription-message.success {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .subscription-message.error {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fecaca;
        }

        /* Subscription loading spinner */
        .subscription-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .subscription-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #9333ea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Notification bell animation */
        @keyframes bell-shake {
            0% { transform: rotate(0); }
            10% { transform: rotate(10deg); }
            20% { transform: rotate(-10deg); }
            30% { transform: rotate(6deg); }
            40% { transform: rotate(-6deg); }
            50% { transform: rotate(0); }
            100% { transform: rotate(0); }
        }

        .bell-icon {
            display: inline-block;
            animation: bell-shake 2s ease infinite;
            animation-delay: 2s;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .badge-group {
                margin-top: 0.5rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .hero {
                padding: 2.5rem 0;
            }
            
            .hero-title {
                gap: 0.5rem;
            }
            
            .hero-emoji {
                font-size: 2rem;
            }
            
            h1 {
                font-size: 1.75rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            .hero-description {
                font-size: 1rem;
                padding: 0 0.5rem;
            }
            
            .card {
                margin-bottom: 1rem;
            }
            
            .card-body {
                padding: 1rem;
            }
            
            .card-header {
                padding: 1rem;
            }
            
            .modal-container {
                width: 95%;
                max-width: 95%;
                margin: 0 2.5%;
            }
            
            .modal-body {
                padding: 1rem;
            }
            
            .timeline-item {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .version-selector {
                flex-direction: column;
                gap: 0.75rem;
                align-items: stretch;
                padding: 0.75rem;
            }
            
            .version-label {
                margin-right: 0;
                text-align: center;
            }
            
            .select-wrapper {
                width: 100%;
            }
            
            .select {
                width: 100%;
            }
            
            .btn {
                padding: 0.75rem 1rem;
                font-size: 0.8rem;
            }
            
            .timeline-header {
                gap: 0.5rem;
            }
            
            .timeline-header button {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
            }
            
            .subscription-form {
                gap: 0.75rem;
            }
            
            .form-control {
                padding: 0.5rem 0.75rem;
                font-size: 0.9rem;
            }
            
            .subscription-message {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            
            .prose {
                font-size: 0.95rem;
            }
            
            .prose h1 { font-size: 1.25rem; }
            .prose h2 { font-size: 1.1rem; }
            .prose h3 { font-size: 1rem; }
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            /* Styles for touch devices */
            .btn, .modal-close, button {
                min-height: 44px;
                min-width: 44px;  /* Apple's recommended touch target size */
            }
            
            .form-control {
                min-height: 44px;
            }
            
            .timeline-item {
                margin-bottom: 1.25rem;
            }
            
            .timeline-header button {
                padding: 0.5rem 0.75rem;
            }
            
            .select {
                min-height: 44px;
            }
            
            /* Add more space between touchable elements */
            .tag-container {
                gap: 1rem;
            }
            
            .hero-buttons {
                gap: 1.25rem;
            }
            
            .footer-links {
                gap: 2rem;
            }
        }
        
        /* Fix for iOS Safari bottom toolbar */
        @supports (-webkit-touch-callout: none) {
            .page-wrapper {
                min-height: -webkit-fill-available;
            }
            
            .modal-overlay {
                padding-bottom: 4rem;
            }
        }

        /* System Notification Styles */
        .status {
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 0.5rem;
        }

        .status.success {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status.error {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fecaca;
        }

        .status.loading {
            background-color: #f3f4f6;
            color: var(--text-medium);
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        /* Ensure the spinner is consistent with delete.html */
        .status .spinner {
            margin: 0.5rem auto;
        }
        
        /* Mobile-friendly adjustments for notifications */
        @media (max-width: 480px) {
            #systemNotificationModal .modal-container {
                width: 90%;
                max-width: 90%;
            }
            
            .status {
                padding: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <!-- Hero Section -->
        <header class="hero">
            <div class="container">
                <div class="hero-content">
                    <div class="hero-title">
                        <span class="hero-emoji">üë®‚Äçüç≥</span>
                        <h1>What's Cooking?</h1>
                    </div>
                    <p class="hero-description">Discover what's brewing in the Appwrite kitchen! AI-powered analysis of the latest commits with real-time insights.</p>
                    
                    <div class="tag-container">
                        <div class="tag">
                            <span>‚ú®</span>
                            AI-Powered
                        </div>
                        <div class="tag">
                            <span>üìà</span>
                            Real-time Updates
                        </div>
                        <div class="tag">
                            <span>üîç</span>
                            Feature Detection
                        </div>
                    </div>
                    
                    <div class="hero-buttons">
                        <button id="learnMoreBtn" class="btn btn-primary">
                            <span>üîç</span>
                            Learn How It Works
                        </button>
                        <button id="subscribeBtn" class="btn btn-secondary">
                            <span class="bell-icon">üîî</span>
                            Subscribe to Alerts
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <div class="container">
                <!-- Version Selector -->
                <div class="version-selector">
                    <span class="version-label">Select Appwrite Version:</span>
                    <div class="select-wrapper">
                        <select id="versionSelector" class="form-control select" onchange="loadAnalysis(this.value)">
                            <option value="1.8.x">Version 1.8.x</option>
                            <option value="1.7.x">Version 1.7.x</option>
                        </select>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="card">
                    <div class="card-body">
                        <div class="loading-container">
                            <div class="spinner"></div>
                            <h3 style="margin: 0; color: var(--primary-color);">Analyzing Latest Commits</h3>
                        </div>
                        <div class="skeleton skeleton-line" style="width: 100%;"></div>
                        <div class="skeleton skeleton-line" style="width: 75%;"></div>
                        <div class="skeleton skeleton-block"></div>
                        <p style="text-align: center; margin-top: 1rem; color: var(--text-medium);">
                            Fetching and analyzing the latest Appwrite commits...
                        </p>
                    </div>
                </div>

                <!-- Error State -->
                <div id="errorState" class="alert error" style="display: none;">
                    <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                    <div>
                        <strong>Analysis Failed</strong>
                        <p style="margin: 0.25rem 0 0 0;">Unable to fetch the latest analysis. Please try refreshing the page.</p>
                        <button onclick="loadAnalysis()" class="btn btn-secondary" style="margin-top: 0.75rem;">
                            <span>üîÑ</span>
                            Retry Analysis
                        </button>
                    </div>
                </div>

                <!-- Results Container -->
                <div id="resultsContainer" style="display: none;">
                    <div class="results-grid">
                        <div class="main-content">
                            <!-- New Features Analysis -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title-group">
                                        <div class="card-icon primary">‚ú®</div>
                                        <h2 class="card-title">Feature Detection Analysis</h2>
                                    </div>
                                    <div class="badge-group">
                                        <div id="versionBadge" class="badge primary">Version 1.8.x</div>
                                        <div id="featureBadge" class="badge success">‚úì New Feature Detected</div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="newFeaturesContent" class="prose"></div>
                                </div>
                            </div>

                            <!-- Commit Summary -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title-group">
                                        <div class="card-icon info">üìä</div>
                                        <h2 class="card-title">Recent Activity Overview</h2>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="summaryContent" class="prose"></div>
                                </div>
                            </div>

                            <!-- Last Updated -->
                            <div class="last-updated">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                    <span>üìÖ</span>
                                    <span id="lastUpdated">Last updated: --</span>
                                </div>
                            </div>
                        </div>

                        <div class="sidebar">
                            <!-- Analysis History -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title-group">
                                        <div class="card-icon warning">üïê</div>
                                        <h2 class="card-title">Analysis History</h2>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="historyContainer">
                                        <div class="skeleton skeleton-block"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Support Section -->
                <div class="card" style="text-align: center; margin-top: 2rem;">
                    <div class="card-body">
                        <h3 style="margin-bottom: 1rem;">Enjoying this tool?</h3>
                        <a href="https://buymeacoffee.com/whmonkey" target="_blank" class="btn btn-primary">
                            <span>‚òï</span>
                            Buy me a coffee
                        </a>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-text">
                        Made with ‚ù§Ô∏è using Appwrite
                    </div>
                    <div class="footer-links">
                        <a href="https://github.com/WhineyMonkey10/WhatsCooking" target="_blank" class="footer-link">
                            View Source
                        </a>
                        <a href="https://github.com/appwrite/appwrite" target="_blank" class="footer-link">
                            Appwrite GitHub
                        </a>
                    </div>
                </div>
            </div>
        </footer>

        <!-- Modal for How It Works -->
        <div id="howItWorksModal" class="modal-overlay">
            <div class="modal-container">
                <div class="modal-header">
                    <h3 class="modal-title">How It Works</h3>
                    <button class="modal-close" id="closeModalBtn">√ó</button>
                </div>
                <div class="modal-body">
                    <p style="color: var(--text-medium); margin-bottom: 1.5rem;">
                        Automated analysis of Appwrite's latest commits every 24 hours
                    </p>
                    <div style="margin-bottom: 1.5rem;">
                        <a href="https://github.com/WhineyMonkey10/WhatsCooking" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem;">
                            <span>‚≠ê</span>
                            View Source Code
                        </a>
                    </div>
                    <div class="features-grid">
                        <div class="feature-card">
                            <div class="feature-icon blue">üïê</div>
                            <h3 class="feature-title">Daily Schedule</h3>
                            <p class="feature-desc">Runs every 24 hours to check for new commits</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon green">üîç</div>
                            <h3 class="feature-title">Smart Analysis</h3>
                            <p class="feature-desc">Examines the 5 most recent commits for changes</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon purple">ü§ñ</div>
                            <h3 class="feature-title">AI Detection</h3>
                            <p class="feature-desc">Uses AI to identify potential new features</p>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon orange">üìä</div>
                            <h3 class="feature-title">Live Results</h3>
                            <p class="feature-desc">Updates automatically with fresh insights</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Subscription Modal -->
        <div id="subscriptionModal" class="modal-overlay">
            <div class="modal-container">
                <div class="modal-header">
                    <h3 class="modal-title">Subscribe to New Feature Alerts</h3>
                    <button class="modal-close" id="closeSubscriptionBtn">√ó</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 1.5rem; color: var(--text-medium);">
                        Get notified by email when we detect new features in Appwrite's latest commits.
                    </p>
                    <form id="subscriptionForm" class="subscription-form">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="emailInput" class="form-label">Email Address</label>
                            <input type="email" id="emailInput" class="form-control" placeholder="your@email.com" required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span>üîî</span>
                            Subscribe
                        </button>
                    </form>
                    <!-- Loading indicator -->
                    <div id="subscriptionLoading" class="subscription-loading" style="display:none;">
                        <div class="subscription-spinner"></div>
                        <span>Processing...</span>
                    </div>
                    <!-- Confirmation for delete -->
                    <div id="deleteConfirm" style="display:none; margin-top:1.5rem;">
                        <div style="margin-bottom:1rem;">
                            <strong>This email is already subscribed.</strong><br>
                            Do you want to receive an email to delete your account and unsubscribe?
                        </div>
                        <div style="display:flex; gap:1rem;">
                            <button id="deleteYesBtn" class="btn btn-primary" type="button">Yes</button>
                            <button id="deleteNoBtn" class="btn btn-secondary" type="button">No</button>
                        </div>
                    </div>
                    <div id="subscriptionSuccess" class="subscription-message success">
                        <strong>Successfully subscribed! Check your email for a verification link to start receiving updates.</strong> You'll receive email notifications when we detect new features. You can always delete your account (and stop receiving emails) by entering your email again here which will send you a confirmation email. Remember to check your spam! You can also unsubscribe at any time by clicking the unsubscribe link in the email which will automatically delete your account.
                    </div>
                    <div id="subscriptionError" class="subscription-message error">
                        <strong>Subscription failed.</strong> <span id="errorMessage">Please try again later.</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Notification Modal -->
        <div id="systemNotificationModal" class="modal-overlay">
            <div class="modal-container" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 class="modal-title" id="notificationTitle">Notification</h3>
                    <button class="modal-close" id="closeNotificationBtn">√ó</button>
                </div>
                <div class="modal-body">
                    <div id="loadingNotification" class="status loading" style="display: none;">
                        <div class="spinner"></div>
                        <p id="loadingMessage">Processing your request...</p>
                    </div>
                    
                    <div id="successNotification" class="status success" style="display: none;">
                        <p><strong id="successTitle">Success!</strong></p>
                        <p id="successMessage">Your request has been processed successfully.</p>
                    </div>
                    
                    <div id="errorNotification" class="status error" style="display: none;">
                        <p><strong id="errorTitle">Error</strong></p>
                        <p id="errorMessage">An error occurred while processing your request. If you tried to delete your account, please click on the link again/refresh the page as it is possible that our service providers are experiencing issues.</p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button id="notificationActionBtn" class="btn btn-primary" style="display: none;">
                            Continue
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Appwrite configuration
        // load environment variables
        let APPWRITE_ENDPOINT, APPWRITE_PROJECT_ID, DATABASE_ID, COLLECTION_ID, FUNCTION_ID;
        let client, databases, account, Query, ID, Functions;

        // Store URL parameters globally so they can be processed after initialization
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');
        const secret = urlParams.get('secret');
        const unsubscribeToken = urlParams.get('unsubscribeToken');

        // Initialize Appwrite only after we have the config variables
        function initializeAppwrite() {
            const { Client, Databases, Query: AppwriteQuery, Account: AppwriteAccount, ID: AppwriteID, Functions: AppwriteFunctions } = Appwrite;
            
            // Make these objects globally available
            Query = AppwriteQuery;
            ID = AppwriteID;
            Functions = AppwriteFunctions;
            
            client = new Client();
            client.setEndpoint(APPWRITE_ENDPOINT).setProject(APPWRITE_PROJECT_ID);
            databases = new Databases(client);
            account = new AppwriteAccount(client);
            
            console.log('Appwrite initialized with config:', {
                APPWRITE_ENDPOINT,
                APPWRITE_PROJECT_ID,
                DATABASE_ID,
                COLLECTION_ID,
                FUNCTION_ID
            });
            
            // Process URL parameters after initialization
            processUrlParams();
            
            // Start loading analysis data after initialization
            loadAnalysis();
        }

        // Function to process URL parameters
        function processUrlParams() {
            // Re-extract URL parameters to ensure they're current
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('userId');
            const secret = urlParams.get('secret');
            const unsubscribeToken = urlParams.get('unsubscribeToken');
            
            console.log('Processing URL parameters:', { 
                userId, 
                secret, 
                unsubscribeToken,
                rawSearch: window.location.search
            });
            
            // Handle unsubscribe token if present
            if (unsubscribeToken) {
                const functions = new Functions(client);
                
                // Show loading notification
                showLoadingNotification('Processing your unsubscribe request...');
                
                // Function to execute account deletion with retry logic
                const executeAccountDeletion = async (retryCount = 0, maxRetries = 5) => {
                    try {
                        // Call the account deletion function with the token as the body
                        const response = await functions.createExecution(
                            FUNCTION_ID,
                            unsubscribeToken
                        );

                        if (response.status === 'completed') {
                            showSuccessNotification('Unsubscribed', 'You have been successfully unsubscribed and your account has been deleted.');
                        } else {
                            throw new Error('Function execution failed');
                        }
                    } catch (error) {
                        console.error(`Unsubscribe error (attempt ${retryCount + 1}):`, error);
                        
                        // If we haven't reached max retries, try again
                        if (retryCount < maxRetries) {
                            // Calculate exponential backoff delay (1s, 2s, 4s, 8s, 16s)
                            const delay = Math.pow(2, retryCount) * 1000;
                            
                            // Update loading message to show retry status
                            loadingMessage.textContent = `Processing your unsubscribe request... (Retry ${retryCount + 1}/${maxRetries})`;
                            
                            // Try again after delay
                            setTimeout(() => executeAccountDeletion(retryCount + 1, maxRetries), delay);
                        } else {
                            // All retries failed
                            showErrorNotification(
                                'Request Failed', 
                                'Failed to process your unsubscribe request after multiple attempts. Please try again later or contact support.'
                            );
                        }
                    }
                };
                
                // Start the deletion process with retry
                executeAccountDeletion();
            }
            
            // If both parameters exist, complete the verification process
            if (userId && secret) {
                try {
                    showLoadingNotification('Verifying your email...');
                    
                    account.updateVerification(userId, secret)
                        .then(() => {
                            showSuccessNotification('Verification Successful', 'Email verification successful! Your subscription is now active.');
                        })
                        .catch(error => {
                            console.error('Verification error:', error);
                            showErrorNotification('Verification Failed', 'The link may have expired or already been used.');
                        });
                } catch (error) {
                    console.error('Verification error:', error);
                    showErrorNotification('Verification Error', 'An unexpected error occurred during verification.');
                }
            }
        }

        fetch('/api/public')
            .then(response => response.json())
            .then(envVars => {
                console.log('Loaded environment variables:', envVars);
                APPWRITE_ENDPOINT = envVars.endpoint;
                APPWRITE_PROJECT_ID = envVars.project;
                DATABASE_ID = envVars.database;
                COLLECTION_ID = envVars.collection;
                FUNCTION_ID = envVars.deleteFunctionId;

                // Initialize Appwrite after variables are set
                initializeAppwrite();
            })
            .catch(error => {
                console.error('Error loading environment variables:', error);
                showError();
            });

        let currentVersion = '1.8.x';
        let analysesCache = { '1.7.x': [], '1.8.x': [] };

        // Load analysis data
        async function loadAnalysis(version = null) {
            if (!databases) {
                console.error('Appwrite not initialized yet');
                showError();
                return;
            }
            
            if (version) {
                currentVersion = version;
            }

            const loadingState = document.getElementById('loadingState');
            const resultsContainer = document.getElementById('resultsContainer');
            const errorState = document.getElementById('errorState');
            const versionSelector = document.getElementById('versionSelector');

            if (versionSelector) {
                versionSelector.value = currentVersion;
            }

            loadingState.style.display = 'block';
            resultsContainer.style.display = 'none';
            errorState.style.display = 'none';

            try {
                console.log(`Fetching documents for version ${currentVersion}...`);
                
                const response = await databases.listDocuments(
                    DATABASE_ID,
                    COLLECTION_ID,
                    [
                        Query.equal('trackedVersion', currentVersion),
                        Query.orderDesc('$createdAt'),
                        Query.limit(1)
                    ]
                );

                if (response.documents.length > 0) {
                    const latestAnalysis = response.documents[0];
                    displayResults(latestAnalysis);
                    loadAnalysisHistory();
                } else {
                    throw new Error(`No analysis data found for version ${currentVersion}`);
                }
            } catch (error) {
                console.error('Error loading analysis:', error);
                showError();
            }
        }

        // Load historical analysis data
        async function loadAnalysisHistory() {
            try {
                const response = await databases.listDocuments(
                    DATABASE_ID,
                    COLLECTION_ID,
                    [
                        Query.equal('trackedVersion', currentVersion),
                        Query.orderDesc('$createdAt'),
                        Query.limit(10)
                    ]
                );

                if (response.documents.length > 0) {
                    displayAnalysisHistory(response.documents.slice(1));
                } else {
                    document.getElementById('historyContainer').innerHTML = 
                        '<div class="timeline-item"><p>No historical data available for this version.</p></div>';
                }
            } catch (error) {
                console.error('Error loading analysis history:', error);
                document.getElementById('historyContainer').innerHTML = 
                    '<div class="timeline-item"><p>Failed to load analysis history.</p></div>';
            }
        }

        // Display historical analysis data
        function displayAnalysisHistory(analyses) {
            const historyContainer = document.getElementById('historyContainer');
            
            if (analyses.length === 0) {
                historyContainer.innerHTML = '<div class="timeline-item"><p>No previous analysis history available yet.</p></div>';
                return;
            }

            let historyHTML = '';
            analyses.forEach((analysis, index) => {
                const date = new Date(analysis.$createdAt).toLocaleString();
                const hasNewFeature = analysis.newFeatureFlag;
                const itemClass = hasNewFeature ? 'feature' : 'no-feature';
                const badgeClass = hasNewFeature ? 'success' : 'neutral';
                const badgeText = hasNewFeature ? '‚úì New Feature' : '‚úó No Features';

                historyHTML += `
                    <div class="timeline-item ${itemClass}">
                        <div class="timeline-header">
                            <div class="timeline-date">
                                <span>üìÖ</span>
                                <span>${date}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div class="badge ${badgeClass}">${badgeText}</div>
                                <button class="btn btn-secondary" onclick="toggleHistory('${analysis.$id}')" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;">
                                    <span id="toggle-${analysis.$id}">Details</span>
                                    <span id="chevron-${analysis.$id}">‚ñº</span>
                                </button>
                            </div>
                        </div>
                        <div id="content-${analysis.$id}" class="timeline-content">
                            <div class="prose">${formatText(analysis.newFeaturesAnalysis)}</div>
                        </div>
                    </div>
                `;
            });

            historyContainer.innerHTML = historyHTML;
        }

        // Toggle history item expansion
        function toggleHistory(id) {
            const content = document.getElementById(`content-${id}`);
            const toggle = document.getElementById(`toggle-${id}`);
            const chevron = document.getElementById(`chevron-${id}`);

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.textContent = 'Details';
                chevron.textContent = '‚ñº';
            } else {
                content.classList.add('expanded');
                toggle.textContent = 'Hide Details';
                chevron.textContent = '‚ñ≤';
            }
        }

        // Format text content with enhanced markdown support
        function formatText(text) {
            if (!text) return 'No data available';

            // Process markdown tables
            const processTable = (text) => {
                let inTable = false;
                let tableHtml = '<table><thead><tr>';
                const lines = text.split('\n');
                const result = [];

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if (line.trim().startsWith('|') && line.trim().endsWith('|')) {
                        if (!inTable) {
                            inTable = true;
                            // Header row
                            const cells = line.split('|').slice(1, -1);
                            cells.forEach(cell => {
                                tableHtml += `<th>${cell.trim()}</th>`;
                            });
                            tableHtml += '</tr></thead><tbody>';
                            // Skip the separator row
                            i++;
                        } else {
                            // Data row
                            tableHtml += '<tr>';
                            const cells = line.split('|').slice(1, -1);
                            cells.forEach(cell => {
                                tableHtml += `<td>${cell.trim()}</td>`;
                            });
                            tableHtml += '</tr>';
                        }
                    } else {
                        if (inTable) {
                            inTable = false;
                            tableHtml += '</tbody></table>';
                            result.push(tableHtml);
                            tableHtml = '<table><thead><tr>';
                        }
                        result.push(line);
                    }
                }

                if (inTable) {
                    tableHtml += '</tbody></table>';
                    result.push(tableHtml);
                }

                return result.join('\n');
            };

            // Apply table processing first
            text = processTable(text);

            // Continue with other markdown formatting
            return text
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/~~(.*?)~~/g, '<del>$1</del>') // Strikethrough
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/^\* (.*$)/gm, '<li>$1</li>')
                .replace(/^- (.*$)/gm, '<li>$1</li>')
                .replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>') // Blockquotes
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>') // Fix link formatting
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/(<li>.*?<\/li>)(\s*<li>.*?<\/li>)*/g, '<ul>$&</ul>')
                .replace(/^(?!<[h1-6ultable])/gm, '<p>')
                .replace(/(?<!<\/[h1-6ultable]>)$/gm, '</p>');
        }

        // Display results
        function displayResults(data) {
            const loadingState = document.getElementById('loadingState');
            const resultsContainer = document.getElementById('resultsContainer');
            const newFeaturesContent = document.getElementById('newFeaturesContent');
            const summaryContent = document.getElementById('summaryContent');
            const lastUpdated = document.getElementById('lastUpdated');
            const versionBadge = document.getElementById('versionBadge');
            const featureBadge = document.getElementById('featureBadge');

            loadingState.style.display = 'none';
            resultsContainer.style.display = 'block';

            newFeaturesContent.innerHTML = formatText(data.newFeaturesAnalysis);
            summaryContent.innerHTML = formatText(data.summary);

            versionBadge.textContent = `Version ${data.trackedVersion}`;
            
            if (data.hasOwnProperty('newFeatureFlag')) {
                featureBadge.className = `badge ${data.newFeatureFlag ? 'success' : 'neutral'}`;
                featureBadge.textContent = data.newFeatureFlag ? '‚úì New Feature Detected' : '‚úó No New Features Found';
            }

            const updateTime = new Date(data.$createdAt).toLocaleString();
            lastUpdated.textContent = `Last updated: ${updateTime}`;
        }

        // Show error state
        function showError() {
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            
            loadingState.style.display = 'none';
            errorState.style.display = 'flex';
        }

        // System Notification Functions
        const systemNotificationModal = document.getElementById('systemNotificationModal');
        const notificationTitle = document.getElementById('notificationTitle');
        const loadingNotification = document.getElementById('loadingNotification');
        const successNotification = document.getElementById('successNotification');
        const errorNotification = document.getElementById('errorNotification');
        const loadingMessage = document.getElementById('loadingMessage');
        const successTitle = document.getElementById('successTitle');
        const successMessage = document.getElementById('successMessage');
        const errorTitle = document.getElementById('errorTitle');
        const errorMessage = document.getElementById('errorMessage');
        const closeNotificationBtn = document.getElementById('closeNotificationBtn');
        const notificationActionBtn = document.getElementById('notificationActionBtn');

        // Show loading notification
        function showLoadingNotification(message) {
            resetNotifications();
            notificationTitle.textContent = 'Processing';
            loadingMessage.textContent = message;
            loadingNotification.style.display = 'block';
            systemNotificationModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Show success notification
        function showSuccessNotification(title, message, actionText = null, actionCallback = null) {
            resetNotifications();
            notificationTitle.textContent = 'Success';
            successTitle.textContent = title;
            successMessage.textContent = message;
            successNotification.style.display = 'block';
            
            if (actionText && actionCallback) {
                notificationActionBtn.textContent = actionText;
                notificationActionBtn.style.display = 'inline-flex';
                notificationActionBtn.onclick = actionCallback;
            }
            
            systemNotificationModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Show error notification
        function showErrorNotification(title, message) {
            resetNotifications();
            notificationTitle.textContent = 'Error';
            errorTitle.textContent = title;
            errorMessage.textContent = message;
            errorNotification.style.display = 'block';
            systemNotificationModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Reset all notifications
        function resetNotifications() {
            loadingNotification.style.display = 'none';
            successNotification.style.display = 'none';
            errorNotification.style.display = 'none';
            notificationActionBtn.style.display = 'none';
            notificationActionBtn.onclick = null;
        }

        // Close notification modal
        closeNotificationBtn.addEventListener('click', function() {
            systemNotificationModal.classList.remove('active');
            document.body.style.overflow = '';
            resetNotifications();
        });

        // Close notification when clicking outside
        systemNotificationModal.addEventListener('click', function(event) {
            if (event.target === systemNotificationModal) {
                systemNotificationModal.classList.remove('active');
                document.body.style.overflow = '';
                resetNotifications();
            }
        });

        // Modal functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Existing initialization
            console.log('DOM loaded');
            
            // Check for URL parameters immediately even before Appwrite is initialized
            // This gives visual feedback to the user while we wait for config to load
            // Re-extract URL parameters directly from window.location.search to ensure they're current
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('userId');
            const secret = urlParams.get('secret');
            const unsubscribeToken = urlParams.get('unsubscribeToken');
            
            console.log('URL parameters at page load:', { 
                userId, 
                secret, 
                unsubscribeToken,
                rawSearch: window.location.search
            });
            
            if (userId && secret) {
                showLoadingNotification('Waiting to verify your email...');
                console.log('URL verification parameters detected, will process after initialization');
            } else if (unsubscribeToken) {
                showLoadingNotification('Waiting to process your unsubscribe request...');
                console.log('Unsubscribe token detected, will process after initialization');
            }
            
            // How it works modal controls
            const howItWorksModal = document.getElementById('howItWorksModal');
            const openModalBtn = document.getElementById('learnMoreBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            
            // Add event listeners only if elements exist
            if (openModalBtn && howItWorksModal) {
                console.log('Learn More button found, adding click handler');
                openModalBtn.addEventListener('click', function() {
                    howItWorksModal.classList.add('active');
                    document.body.style.overflow = 'hidden'; // Prevent scrolling
                });
            } else {
                console.error('Learn More button or modal not found', { 
                    openModalBtn: !!openModalBtn, 
                    howItWorksModal: !!howItWorksModal 
                });
            }
            
            if (closeModalBtn && howItWorksModal) {
                closeModalBtn.addEventListener('click', function() {
                    howItWorksModal.classList.remove('active');
                    document.body.style.overflow = ''; // Enable scrolling
                });
            }
            
            // Close modal when clicking outside
            if (howItWorksModal) {
                howItWorksModal.addEventListener('click', function(event) {
                    if (event.target === howItWorksModal) {
                        howItWorksModal.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                });
            }
            
            // Subscription modal controls
            const subscriptionModal = document.getElementById('subscriptionModal');
            const subscribeBtn = document.getElementById('subscribeBtn');
            const closeSubscriptionBtn = document.getElementById('closeSubscriptionBtn');
            const subscriptionForm = document.getElementById('subscriptionForm');
            const subscriptionSuccess = document.getElementById('subscriptionSuccess');
            const subscriptionError = document.getElementById('subscriptionError');
            const errorMessage = document.getElementById('errorMessage');
            const deleteConfirm = document.getElementById('deleteConfirm');
            const deleteYesBtn = document.getElementById('deleteYesBtn');
            const deleteNoBtn = document.getElementById('deleteNoBtn');
            
            // Check if form exists before accessing its elements
            let submitButton, originalButtonContent;
            if (subscriptionForm) {
                submitButton = subscriptionForm.querySelector('button[type="submit"]');
                if (submitButton) {
                    originalButtonContent = submitButton.innerHTML;
                }
            }

            if (subscribeBtn && subscriptionModal) {
                console.log('Subscribe button found, adding click handler');
                subscribeBtn.addEventListener('click', function() {
                    subscriptionModal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    
                    if (subscriptionForm) {
                        subscriptionForm.reset();
                        subscriptionForm.style.display = 'flex';
                    }
                    
                    if (subscriptionSuccess) {
                        subscriptionSuccess.style.display = 'none';
                    }
                    
                    if (subscriptionError) {
                        subscriptionError.style.display = 'none';
                    }
                    
                    if (deleteConfirm) {
                        deleteConfirm.style.display = 'none';
                    }
                
                    // Reset button to original state
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonContent;
                    }
                });
            } else {
                console.error('Subscribe button or modal not found', { 
                    subscribeBtn: !!subscribeBtn, 
                    subscriptionModal: !!subscriptionModal 
                });
            }

            if (closeSubscriptionBtn && subscriptionModal) {
                closeSubscriptionBtn.addEventListener('click', function() {
                    subscriptionModal.classList.remove('active');
                    document.body.style.overflow = '';
                });
            }

            if (subscriptionModal) {
                subscriptionModal.addEventListener('click', function(event) {
                    if (event.target === subscriptionModal) {
                        subscriptionModal.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                });
            }

            // Handle subscription form submission
            if (subscriptionForm && submitButton) {
                subscriptionForm.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    
                    // Update button to loading state
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<div class="subscription-spinner" style="width: 20px; height: 20px; margin: 0 auto;"></div>';
                
                subscriptionSuccess.style.display = 'none';
                subscriptionError.style.display = 'none';
                deleteConfirm.style.display = 'none';

                const email = document.getElementById('emailInput').value.trim();
                if (!email) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonContent;
                    showSubscriptionError('Please enter a valid email address.');
                    return;
                }

                try {
                    // Create new user
                    const randomPassword = Math.random().toString(36).slice(-10);
                    try {
                        await account.create('unique()', email, randomPassword, email.split('@')[0]);
                        await account.createEmailPasswordSession(email, randomPassword);
                        await account.createVerification(window.location.origin + '/');
                        showSubscriptionSuccess();
                    } catch (error) {
                        console.error('Error creating user:', error);
                        
                        // Check for user already exists error
                        if (error && error.type === "user_already_exists") {
                            // Show confirmation dialog
                            submitButton.disabled = false;
                            submitButton.innerHTML = originalButtonContent;
                            subscriptionForm.style.display = 'none';
                            deleteConfirm.style.display = 'block';

                            deleteYesBtn.onclick = async function() {
                                deleteYesBtn.disabled = true;
                                deleteYesBtn.innerHTML = '<div class="subscription-spinner" style="width: 20px; height: 20px; margin: 0 auto;"></div>';
                                deleteNoBtn.disabled = true;
                                
                                try {
                                    // Send delete account email
                                    await account.createMagicURLToken(ID.unique(),
                                    email,
                                    window.location.origin + '/delete.html');
                                    showSubscriptionSuccess('A confirmation email has been sent to delete your account. Please check your inbox. Remember to check your spam folder!');
                                } catch (err) {
                                    console.error('Error sending recovery email:', err);
                                    showSubscriptionError('Failed to send delete email. Please try again later.');
                                    deleteYesBtn.disabled = false;
                                    deleteYesBtn.innerHTML = 'Yes';
                                    deleteNoBtn.disabled = false;
                                }
                            };

                            deleteNoBtn.onclick = function() {
                                subscriptionModal.classList.remove('active');
                                document.body.style.overflow = '';
                            };
                        } else {
                            showSubscriptionError('Failed to subscribe. Please try again later.');
                        }
                    }
                } catch (error) {
                    console.error('General subscription error:', error);
                    showSubscriptionError('Failed to subscribe. Please try again later.');
                } finally {
                    // Ensure button is reset in case of any unexpected errors
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonContent;
                }
            });
            }

            function showSubscriptionSuccess(msg) {
                subscriptionForm.style.display = 'none';
                subscriptionSuccess.style.display = 'block';
                subscriptionError.style.display = 'none';
                
                // Reset button
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonContent;
                
                if (msg) subscriptionSuccess.innerHTML = `<strong>Success!</strong> ${msg}`;
            }

            function showSubscriptionError(message) {
                subscriptionError.style.display = 'block';
                errorMessage.textContent = message || 'Please try again later.';
                
                // Reset button
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonContent;
            }

            // Close modals with escape key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    if (howItWorksModal && howItWorksModal.classList.contains('active')) {
                        howItWorksModal.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                    if (subscriptionModal && subscriptionModal.classList.contains('active')) {
                        subscriptionModal.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                }
            });
        });

        // Auto-refresh every 5 minutes
        setInterval(() => {
            if (typeof databases !== 'undefined' && databases) {
                loadAnalysis(currentVersion);
            }
        }, 5 * 60 * 1000);
    
    </script>
</body>
</html>